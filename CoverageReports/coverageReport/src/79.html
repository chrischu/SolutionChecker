<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>d:\development\solutioninspector\src\solutioninspector.api\commands\inspectcommand.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using JetBrains.Annotations;
using Microsoft.Build.Exceptions;
using NLog;
using SolutionInspector.Api.Configuration;
using SolutionInspector.Api.ObjectModel;
using SolutionInspector.Api.Reporting;
using SolutionInspector.Api.Rules;
using SolutionInspector.Api.Utilities;

namespace SolutionInspector.Api.Commands
{
  internal class InspectCommand : SolutionInspectorCommand&lt;InspectCommand.RawArguments, InspectCommand.ParsedArguments&gt;
  {
    private static readonly Logger s_logger = LogManager.GetCurrentClassLogger();

    private readonly IConfigurationLoader _configurationLoader;
    private readonly IRuleAssemblyLoader _ruleAssemblyLoader;
    private readonly ISolutionLoader _solutionLoader;
    private readonly IRuleCollectionBuilder _ruleCollectionBuilder;
    private readonly IViolationReporterFactory _violationReporterFactory;

    public InspectCommand (
        IConfigurationLoader configurationLoader,
        IRuleAssemblyLoader ruleAssemblyLoader,
        ISolutionLoader solutionLoader,
        IRuleCollectionBuilder ruleCollectionBuilder,
        IViolationReporterFactory violationReporterFactory)
        : base(&quot;inspect&quot;, &quot;Inspects a given solution for rule violations.&quot;)
    {
      _configurationLoader = configurationLoader;
      _ruleAssemblyLoader = ruleAssemblyLoader;
      _solutionLoader = solutionLoader;
      _ruleCollectionBuilder = ruleCollectionBuilder;
      _violationReporterFactory = violationReporterFactory;
    }

    protected override void SetupArguments (IArgumentsBuilder&lt;RawArguments&gt; argumentsBuilder)
    {
      var executableName = Path.GetFileName(Environment.GetCommandLineArgs()[0]);

      argumentsBuilder
          .Option&lt;ViolationReportFormat&gt;(
              &quot;reportFormat&quot;,
              &quot;f&quot;,
              $&quot;Controls the format of the violation report ({string.Join(&quot;|&quot;, Enum.GetNames(typeof(ViolationReportFormat)))}).&quot;,
              (a, v) =&gt; a.ReportFormat = v)
          .Option&lt;string&gt;(
              &quot;reportOutputFile&quot;,
              &quot;o&quot;,
              &quot;Writes the violation report to the given file instead of to the console.&quot;,
              (a, v) =&gt; a.ReportOutputFile = v?.Trim())
          .Option&lt;string&gt;(
              &quot;configurationFile&quot;,
              &quot;c&quot;,
              $@&quot;Controls which configuration file is used. Valid values are: 
AppConfig: Use the {executableName}.config file next to {executableName}.
Solution: Use the &lt;solutionFilePath&gt;.SolutionInspectorConfig file.
&lt;FilePath&gt;: Uses the given configuration file.&quot;,
              (a, v) =&gt; a.ConfigurationFile = v?.Trim()
          )
          .Values(c =&gt; c.Value(&quot;solutionFilePath&quot;, (a, v) =&gt; a.SolutionFilePath = v));
    }

    protected override ParsedArguments ValidateAndParseArguments (RawArguments arguments, Func&lt;string, Exception&gt; reportError)
    {
      var configuration = ValidateAndLoadConfiguration(arguments, reportError);
      var solution = ValidateAndParseSolution(configuration, arguments, reportError);
      var rules = _ruleCollectionBuilder.Build(configuration.Rules);

      return new ParsedArguments(solution, rules, arguments.ReportFormat, arguments.ReportOutputFile, configuration);
    }

    private ISolutionInspectorConfiguration ValidateAndLoadConfiguration (RawArguments arguments, Func&lt;string, Exception&gt; reportError)
    {
      try
      {
        if (arguments.ConfigurationFile == &quot;AppConfig&quot; || arguments.ConfigurationFile == null)
          return _configurationLoader.LoadAppConfigFile();

        var configurationFilePath = arguments.ConfigurationFile == &quot;Solution&quot;
          ? arguments.SolutionFilePath + &quot;.SolutionInspectorConfig&quot;
          : arguments.ConfigurationFile;

        return _configurationLoader.Load(configurationFilePath);
      }
      catch (FileNotFoundException ex)
      {
        s_logger.Error(ex, &quot;Error while loading configuration file.&quot;);
        throw reportError(ex.Message);
      }
      catch (Exception ex)
      {
        s_logger.Error(ex, &quot;Error while loading configuration file.&quot;);
        throw reportError($&quot;Unexpected error when loading configuration file: {ex.Message}.&quot;);
      }
    }

    private ISolution ValidateAndParseSolution (
        ISolutionInspectorConfiguration configuration,
        RawArguments arguments,
        Func&lt;string, Exception&gt; reportError)
    {
      try
      {
        return _solutionLoader.Load(arguments.SolutionFilePath, configuration.MsBuildParsing);
      }
      catch (SolutionNotFoundException)
      {
        throw reportError($&quot;Given solution file &#39;{arguments.SolutionFilePath}&#39; could not be found.&quot;);
      }
      catch (InvalidProjectFileException ex)
      {
        s_logger.Error(ex, &quot;Error while loading solution.&quot;);
        throw reportError(
            $&quot;Given solution file &#39;{arguments.SolutionFilePath}&#39; contains an invalid project file &#39;{ex.ProjectFile}&#39; &quot; +
            &quot;(for detailed error information see the log file &#39;SolutionInspector.log&#39;).&quot;);
      }
      catch (Exception ex)
      {
        s_logger.Error(ex, &quot;Error while loading solution.&quot;);
        throw reportError($&quot;Unexpected error when loading solution file &#39;{arguments.SolutionFilePath}&#39;: {ex.Message} (for further details see the&quot; +
                          &quot;log file &#39;SolutionInspector.log&#39;).&quot;);
      }
    }

    protected override int Run (ParsedArguments arguments)
    {
      using (var solution = arguments.Solution)
      {
        s_logger.Info(&quot;Loading rule assemblies...&quot;);

        _ruleAssemblyLoader.LoadRuleAssemblies(arguments.Configuration.RuleAssemblyImports.Imports);

        s_logger.Info($&quot;Inspecting solution &#39;{solution.FullPath}&#39;...&quot;);

        var violations = GetRuleViolations(solution, arguments.Rules).ToArray();

        if (violations.Any())
        {
          using (var reporter = CreateViolationReporter(arguments))
            reporter.Report(violations);
          return 1;
        }

        return 0;
      }
    }

    private IViolationReporter CreateViolationReporter (ParsedArguments arguments)
    {
      if (arguments.ReportOutputFile != null)
        return _violationReporterFactory.CreateFileReporter(arguments.ReportFormat, arguments.ReportOutputFile);

      return _violationReporterFactory.CreateConsoleReporter(arguments.ReportFormat);
    }

    private IEnumerable&lt;IRuleViolation&gt; GetRuleViolations (ISolution solution, IRuleCollection rules)
    {
      var ruleViolations = new List&lt;IRuleViolation&gt;();
      int previousViolationCount = 0;

      s_logger.Info($&quot;Checking for solution rule violations in solution &#39;{solution.FullPath}&#39;...&quot;);
      foreach (var solutionRule in rules.SolutionRules)
        ruleViolations.AddRange(solutionRule.Evaluate(solution));
      s_logger.Info(
          $&quot;Finished checking for solution rule violations in solution &#39;{solution.FullPath}&#39;: &quot; +
          $&quot;Found {ruleViolations.Count - previousViolationCount} violations.&quot;);

      foreach (var project in solution.Projects)
      {
        s_logger.Info($&quot;Checking for project rule violations in project &#39;{project.FullPath}&#39;...&quot;);
        previousViolationCount = ruleViolations.Count;
        foreach (var projectRule in rules.ProjectRules)
          ruleViolations.AddRange(projectRule.Evaluate(project));
        s_logger.Info(
            $&quot;Finished checking for project rule violations in project &#39;{project.FullPath}&#39;: &quot; +
            $&quot;Found {ruleViolations.Count - previousViolationCount} violations.&quot;);
      }

      foreach (var project in solution.Projects)
      {
        s_logger.Info($&quot;Checking for project item rule violations in project &#39;{project.FullPath}&#39;...&quot;);
        previousViolationCount = ruleViolations.Count;

        foreach (var projectItem in project.ProjectItems)
        {
          s_logger.Debug($&quot;Checking for project item rule violations in project item &#39;{projectItem.FullPath}&#39;...&quot;);
          foreach (var projectItemRule in rules.ProjectItemRules)
            ruleViolations.AddRange(projectItemRule.Evaluate(projectItem));
        }

        s_logger.Info(
            $&quot;Finished checking for project item rule violations in project &#39;{project.FullPath}&#39;: &quot; +
            $&quot;Found {ruleViolations.Count - previousViolationCount} violations.&quot;);
      }

      s_logger.Info(
          $&quot;Finished checking for violations in solution &#39;{solution.FullPath}&#39;: &quot; +
          $&quot;Found {ruleViolations.Count} total violations.&quot;);
      return ruleViolations;
    }

    public class RawArguments
    {
      public string SolutionFilePath { get; set; }
      public ViolationReportFormat ReportFormat { get; set; }
      public string ReportOutputFile { get; set; }
      public string ConfigurationFile { get; set; }
    }

    public class ParsedArguments
    {
      public ISolution Solution { get; }
      public IRuleCollection Rules { get; }
      public ViolationReportFormat ReportFormat { get; }
      public string ReportOutputFile { get; }
      public ISolutionInspectorConfiguration Configuration { get; }

      public ParsedArguments (
          ISolution solution,
          IRuleCollection rules,
          ViolationReportFormat reportFormat,
          [CanBeNull] string reportOutputFile,
          ISolutionInspectorConfiguration configuration)
      {
        Solution = solution;
        Rules = rules;
        ReportFormat = reportFormat;
        ReportOutputFile = reportOutputFile;
        Configuration = configuration;
      }
    }
  }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[32,11,32,76,1],[34,7,34,50,1],[35,7,35,48,1],[36,7,36,40,1],[37,7,37,54,1],[38,7,38,60,1],[39,5,39,6,1],[43,7,43,82,1],[45,7,50,25,1],[50,43,55,25,1],[55,55,63,25,1],[63,56,65,24,1],[65,85,65,87,1],[66,5,66,6,1],[70,7,70,80,1],[71,7,71,86,1],[72,7,72,69,1],[74,7,74,118,1],[81,9,81,95,1],[82,11,82,59,1],[84,9,86,41,1],[88,9,88,65,1],[90,7,90,39,1],[92,9,92,71,1],[93,9,93,39,1],[95,7,95,27,1],[97,9,97,71,1],[98,9,98,95,1],[100,5,100,6,1],[109,9,109,95,1],[111,7,111,40,1],[113,9,113,102,1],[115,7,115,45,1],[117,9,117,61,1],[118,9,120,91,1],[122,7,122,27,1],[124,9,124,61,1],[125,9,126,65,1],[128,5,128,6,1],[132,14,132,47,1],[134,9,134,53,1],[136,9,136,101,1],[138,9,138,72,1],[140,9,140,81,1],[142,9,142,30,1],[144,18,144,67,1],[145,13,145,41,1],[146,11,146,20,1],[149,9,149,18,1],[151,5,151,6,1],[155,7,155,46,1],[156,9,156,113,1],[158,7,158,86,1],[163,7,163,55,1],[164,7,164,38,1],[166,7,166,100,1],[167,36,167,55,1],[167,16,167,32,1],[168,9,168,66,1],[167,33,167,35,1],[169,7,171,81,1],[173,31,173,48,1],[173,16,173,27,1],[175,9,175,99,1],[176,9,176,55,1],[177,37,177,55,1],[177,18,177,33,1],[178,11,178,66,1],[177,34,177,36,1],[179,9,181,83,1],[173,28,173,30,1],[184,31,184,48,1],[184,16,184,27,1],[186,9,186,104,1],[187,9,187,55,1],[189,37,189,57,1],[189,18,189,33,1],[191,11,191,116,1],[192,43,192,65,1],[192,20,192,39,1],[193,13,193,76,1],[192,40,192,42,1],[189,34,189,36,1],[196,9,198,83,1],[184,28,184,30,1],[201,7,203,62,1],[204,7,204,29,1],[18,5,18,82,1],[209,40,209,44,1],[209,45,209,49,1],[210,51,210,55,1],[210,56,210,60,1],[211,40,211,44,1],[211,45,211,49,1],[212,41,212,45,1],[212,46,212,50,1],[217,35,217,39,1],[218,38,218,42,1],[219,51,219,55,1],[220,40,220,44,1],[221,62,221,66,1],[223,7,228,57,1],[230,9,230,29,1],[231,9,231,23,1],[232,9,232,37,1],[233,9,233,45,1],[234,9,234,39,1],[235,7,235,8,1],[50,25,50,43,1],[55,25,55,55,1],[63,25,63,56,1],[65,24,65,62,1],[65,84,65,85,1],[65,62,65,84,1]]);
    </script>
  </body>
</html>